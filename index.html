<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>English Pronunciation Invaders</title>
    <style>
        body { background: #1a1a2e; color: #fff; text-align: center; font-family: 'Arial', sans-serif; overflow: hidden; }
        canvas { background: #000; display: block; margin: 10px auto; border: 3px solid #4ecca3; box-shadow: 0 0 20px rgba(78, 204, 163, 0.5); }
        .ui { font-size: 1.2rem; margin-bottom: 10px; color: #4ecca3; }
        .word-hint { font-size: 1.5rem; color: #ff4b2b; font-weight: bold; }
    </style>
</head>
<body>
    <h1>PRONUNCIATION SHOOTER</h1>
    <div class="ui">Score: <span id="score">0</span> | <span id="status">Microphone: Loading...</span></div>
    <div class="word-hint">画面の英単語を叫べ！</div>
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <p>マイクを許可して、敵の英単語を正しく発音すると自動で攻撃します。</p>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const scoreEl = document.getElementById("score");
        const statusEl = document.getElementById("status");

        let score = 0;
        const player = { x: 380, y: 450, w: 40, h: 20 };
        const bullets = [];
        const enemies = [];
        const words = ["Apple", "Blue", "Cat", "Dog", "Egg", "Fish", "Good", "Home"];

        // 敵の生成（単語付き）
        function initEnemies() {
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 6; c++) {
                    const word = words[Math.floor(Math.random() * words.length)];
                    enemies.push({
                        x: c * 100 + 100,
                        y: r * 60 + 50,
                        w: 60,
                        h: 30,
                        word: word.toLowerCase(),
                        displayWord: word
                    });
                }
            }
        }
        initEnemies();

        // --- 音声認識のセットアップ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            statusEl.innerText = "Error: Browser not supported";
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = () => statusEl.innerText = "Status: Listening... (Say a word!)";
            recognition.onerror = () => statusEl.innerText = "Status: Mic Error";
            
            recognition.onresult = (event) => {
                const speechResult = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                console.log("Detected:", speechResult);
                
                // 発音された単語と一致する敵を狙い撃ち
                enemies.forEach((en, index) => {
                    if (speechResult.includes(en.word)) {
                        fireBulletAt(en);
                    }
                });
            };
            recognition.start();
        }

        function fireBulletAt(enemy) {
            bullets.push({
                x: player.x + player.w / 2,
                y: player.y,
                targetX: enemy.x + enemy.w / 2,
                targetY: enemy.y + enemy.h / 2,
                speed: 10,
                active: true,
                targetEnemy: enemy
            });
        }

        function update() {
            // 弾の移動と命中判定
            bullets.forEach((b, bi) => {
                const dx = b.targetX - b.x;
                const dy = b.targetY - b.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < 10) {
                    const ei = enemies.indexOf(b.targetEnemy);
                    if (ei > -1) {
                        enemies.splice(ei, 1);
                        score += 100;
                        scoreEl.innerText = score;
                    }
                    bullets.splice(bi, 1);
                } else {
                    b.x += (dx / dist) * b.speed;
                    b.y += (dy / dist) * b.speed;
                }
            });

            if (enemies.length === 0) initEnemies(); // 全滅したら次
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 自機
            ctx.fillStyle = "#4ecca3";
            ctx.fillRect(player.x, player.y, player.w, player.h);

            // 敵と単語
            enemies.forEach(en => {
                ctx.fillStyle = "#ff4b2b";
                ctx.fillRect(en.x, en.y, en.w, en.h);
                ctx.fillStyle = "#fff";
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText(en.displayWord, en.x + en.w / 2, en.y - 5);
            });

            // 弾
            ctx.strokeStyle = "#ffff00";
            ctx.lineWidth = 3;
            bullets.forEach(b => {
                ctx.beginPath();
                ctx.moveTo(b.x, b.y);
                ctx.lineTo(b.x, b.y - 10);
                ctx.stroke();
            });

            update();
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
