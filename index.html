<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Street Witness - English Build Game</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; }
        #game-container { max-width: 700px; margin: 30px auto; padding: 20px; border: 3px solid #333; border-radius: 20px; }
        #mission-card { background: #2a2a2a; padding: 15px; border-radius: 10px; border-left: 10px solid #ffcc00; margin-bottom: 20px; }
        .mission-text { font-size: 1.4rem; color: #ffcc00; font-weight: bold; }
        .choice-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .choice-btn { border: 2px solid #555; padding: 10px 20px; border-radius: 30px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .choice-btn.active { border-color: #00ffcc; color: #00ffcc; background: rgba(0, 255, 204, 0.1); }
        #sentence-display { font-size: 1.8rem; height: 3rem; margin: 20px 0; color: #fff; background: #000; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        #timer { font-size: 2rem; color: #ff3366; font-weight: bold; }
        button#mic-btn { background: #ff3366; color: white; border: none; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 51, 102, 0.4); }
        .success { color: #00ffcc; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>STREET WITNESS</h1>
    <div id="timer">Time: 30</div>
    
    <div id="mission-card">
        <p>MISSION: ä»¥ä¸‹ã®çŠ¶æ³ã‚’å ±å‘Šã›ã‚ˆï¼</p>
        <div class="mission-text" id="mission-goal">Loading...</div>
    </div>

    <div id="sentence-display">... å ±å‘Šã‚’çµ„ã¿ç«‹ã¦ã‚ ...</div>

    <div class="choice-container" id="choices"></div>

    <button id="mic-btn">ğŸ™ SPEAK</button>
    <p>Status: <span id="status">Ready</span></p>
    <p style="font-size: 0.9rem; color: #666;">You said: <span id="transcript">-</span></p>
</div>

<script>
    const missionGoalEl = document.getElementById('mission-goal');
    const sentenceDisplay = document.getElementById('sentence-display');
    const choicesContainer = document.getElementById('choices');
    const timerEl = document.getElementById('timer');
    const micBtn = document.getElementById('mic-btn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');

    const scenarios = [
        { goal: "ã€Œç§ã®çŒ«ãŒã€ã€Œãƒ”ã‚¶ã‚’ã€ã€Œå…¬åœ’ã§ã€ã€Œé£Ÿã¹ã¦ã„ã‚‹ã€", answer: ["My cat", "is eating", "a pizza", "at the park"] },
        { goal: "ã€Œæœ‰åäººãŒã€ã€Œã‚¹ãƒãƒ›ã‚’ã€ã€Œã‚¿ã‚¯ã‚·ãƒ¼ã«ã€ã€Œå¿˜ã‚ŒãŸã€", answer: ["A celebrity", "forgot", "a smartphone", "in the taxi"] },
        { goal: "ã€Œãƒ­ãƒœãƒƒãƒˆãŒã€ã€Œå†™çœŸã‚’ã€ã€Œæœˆã§ã€ã€Œæ’®ã£ãŸã€", answer: ["A robot", "took", "a photo", "on the moon"] }
    ];

    const allOptions = {
        subject: ["My cat", "A celebrity", "A robot", "The police"],
        verb: ["is eating", "forgot", "took", "found"],
        object: ["a pizza", "a smartphone", "a photo", "a mysterious key"],
        place: ["at the park", "in the taxi", "on the moon", "at the station"]
    };

    let currentStep = 0; // 0:Subj, 1:Verb, 2:Obj, 3:Place, 4:Full Sentence
    let currentScenarioIdx = 0;
    let builtSentence = [];
    let timeLeft = 30;
    let timerInterval;

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';

    function initGame() {
        currentScenarioIdx = Math.floor(Math.random() * scenarios.length);
        missionGoalEl.innerText = scenarios[currentScenarioIdx].goal;
        currentStep = 0;
        builtSentence = [];
        sentenceDisplay.innerText = "...";
        sentenceDisplay.classList.remove('success');
        updateChoices();
        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timeLeft = 30;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerEl.innerText = `Time: ${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("Time Over! è¨¼è¨€å¤±æ•—...");
                initGame();
            }
        }, 1000);
    }

    function updateChoices() {
        choicesContainer.innerHTML = '';
        const types = ['subject', 'verb', 'object', 'place'];
        if (currentStep < 4) {
            const currentType = types[currentStep];
            allOptions[currentType].forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn active';
                btn.innerText = opt;
                choicesContainer.appendChild(btn);
            });
        } else {
            choicesContainer.innerHTML = '<p>ã•ã‚ã€å®Œæˆã—ãŸæ–‡ã‚’ä¸€åº¦ã«èª­ã¿ä¸Šã’ã‚ï¼</p>';
        }
    }

    micBtn.onclick = () => {
        recognition.start();
        statusEl.innerText = "Listening...";
    };

    recognition.onresult = (event) => {
        const speech = event.results[0][0].transcript.toLowerCase().replace(/[.,?!]/g, "");
        transcriptEl.innerText = speech;

        const types = ['subject', 'verb', 'object', 'place'];
        
        if (currentStep < 4) {
            // ãƒ‘ãƒ¼ãƒ„é¸æŠãƒ•ã‚§ãƒ¼ã‚º
            const options = allOptions[types[currentStep]];
            const matched = options.find(opt => speech.includes(opt.toLowerCase()));

            if (matched) {
                builtSentence.push(matched);
                sentenceDisplay.innerText = builtSentence.join(" ");
                currentStep++;
                updateChoices();
                statusEl.innerText = "Check! Next part...";
            } else {
                statusEl.innerText = "Wait, what? Try again.";
            }
        } else {
            // å…¨æ–‡éŸ³èª­ãƒ•ã‚§ãƒ¼ã‚º
            const finalTarget = builtSentence.join(" ").toLowerCase();
            if (speech.includes(finalTarget)) {
                clearInterval(timerInterval);
                sentenceDisplay.innerText = "CLEAR: " + builtSentence.join(" ");
                sentenceDisplay.classList.add('success');
                statusEl.innerText = "Mission Complete!!";
                setTimeout(initGame, 3000);
            } else {
                statusEl.innerText = "Read the whole sentence clearly!";
            }
        }
    };

    initGame();
</script>
</body>
</html>
